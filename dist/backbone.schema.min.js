/**
 * Backbone.Schema v1.0.1
 * https://github.com/DreamTheater/Backbone.Schema
 *
 * Copyright (c) 2015 Dmytro Nemoga
 * Released under the MIT license
 */
!function(a){"use strict";"object"==typeof module&&"object"==typeof exports?exports.Schema=a(require("underscore"),require("backbone"),require("globalize")):"function"==typeof define&&define.amd?define(["underscore","backbone","globalize"],a):window.Backbone.Schema=a(window._,window.Backbone,window.Globalize)}(function(a,b,c){"use strict";var d=b.Schema=function(b){return this instanceof d?(this.model=b,this.attributes={},b.schema=this,void a.extend(b,{toJSON:a.wrap(b.toJSON,function(c,d){var e,f=c.call(this,d);return a.each(f,function(c,f,g){if(b.schema.attributes[f]){if(e=b.schema.attributes[f].toJSON,e=a.isUndefined(e)?!0:e,e===!1)return void delete g[f];a.isFunction(e)&&(c=e(f,c,d))}g[f]=c}),f}),get:a.wrap(b.get,function(a,b){var c=this.schema.attributes[b],d=c&&c.getter,e=a.call(this,b);return d?d(b,e):e}),set:a.wrap(b.set,function(b,c,d,e){var f;!c||a.isObject(c)?(f=c,e=d):(f={})[c]=d;var g={};return a.each(f,function(b,c,d){var e=this.schema.attributes[c],f=e&&e.setter,h=f?f(c,b):a.pick(d,c);a.each(h,function(a,b){g[b]=a})},this),b.call(this,g,e)})})):new d(b)};return a.extend(d,{extend:b.Model.extend},{handlers:{string:{getter:function(a,b){return b},setter:function(b,c){return a.isString(c)?c:String(c)}},"boolean":{getter:function(a,b){return b},setter:function(b,c){return a.isBoolean(c)?c:Boolean(c)}},number:{getter:function(a,b,d){var e=d.culture,f=d.format;return f?c.format(b,f,e):b},setter:function(b,d,e){var f=e.culture,g=Number(d);return isNaN(g)&&(g=a.isString(d)?d:String(d)),a.isNumber(g)?g:c.parseFloat(g,f)||"NaN"}},datetime:{getter:function(b,d,e){var f=e.culture,g=e.format;return a.isDate(d)||(d=new Date(d)),g?c.format(d,g,f):d},setter:function(a,b,d){var e=d.culture,f=d.format,g=d.standard;b=f?c.parseDate(b,f,e)||new Date(b):new Date(b);var h;switch(g){case"iso":h=b.toJSON()?b.toISOString():b.toString();break;case"unix":h=b.getTime();break;default:h=b}return h}},locale:{getter:function(a,b,d){var e=d.culture;return c.localize(b,e)||b},setter:function(b,d,e){var f,g=e.culture,h=c.findClosestCulture(g).messages;return a.find(h,function(a,b){return a===d?f=b:!1}),f||String(d)}},model:{getter:function(a,b){return b},setter:function(c,d,e){e=a.clone(e);var f,g=e.source,h=e.clear;f=e.model||g.model;var i,j=this.model.get(c);return i=d instanceof b.Model?d===j?d:a.clone(d.attributes):g?g.get(d):d,i instanceof f?j=i:j instanceof f?h?j.clear().set(i,e):j.set(i,e):j=new f(i,e),j.source=g||null,j},toJSON:function(a,b,c){return b.source?b.id:b.toJSON(c)}},collection:{getter:function(a,b){return b},setter:function(c,d,e){e=a.clone(e);var f,g=e.source,h=e.reset;f=e.collection||g.constructor;var i,j=this.model.get(c);return i=d instanceof b.Collection?d===j?d:a.clone(d.models):g?g.filter(function(b){return a.contains(d,b.id)}):d,i instanceof f?j=i:j instanceof f?h?j.reset(i,e):j.set(i,e):j=new f(i,e),j.source=g||null,j},toJSON:function(b,c,d){return c.source?a.pluck(c.models,"id"):c.toJSON(d)}}}}),a.extend(d.prototype,{constructor:d},{define:function(b,c){var d;return!b||a.isObject(b)?d=b:(d={})[b]=c,a.each(d,function(a,b){a=a||{},this._addAttribute(b,a)},this),this.refresh(),this},refresh:function(){var b=this.attributes,c={};return a.each(b,function(b,d){a.isUndefined(this.model.attributes[d])||(c[d]=this.model.attributes[d])},this),this.model.set(c),this},defaultValue:function(b){var c=a.result(this.model,"defaults");return c&&a.has(c,b)?c[b]:null},_addAttribute:function(b,c){var d=c.type,e=c.array,f=!a.isUndefined(e),g=c.model,h=c.collection,i=this.constructor;d||(e?d=e:g?d="model":h&&(d="collection"));var j=i.handlers[d],k=j&&j.getter,l=j&&j.setter,m=a.isUndefined(c.toJSON)?j&&j.toJSON:c.toJSON;return this.attributes[b]=a.defaults(c,{getter:this._transformGetterToHandleArrays(k,d,f,c),setter:this._transformSetterToHandleArrays(l,d,f,c)}),a.isUndefined(m)||(a.isFunction(m)?m=this._transformToJsonToHandleArrays(m,f):"getter"===m&&(m=this.attributes[b].getter),this.attributes[b].toJSON=m),this._bindHandlers(c),this},_transformGetterToHandleArrays:function(b,c,d,e){return a.wrap(b,function(b,c,f){var g=[],h=d?f:[f];return a.each(h,function(d){var f;f=a.isNull(d)?d:b?b.call(this,c,d,e):d,g.push(f)},this),d?g:g[0]})},_transformSetterToHandleArrays:function(b,c,d,e){return a.wrap(b,function(b,f,g){var h=[],i=d?g:[g];return a.each(i,function(d){a.isUndefined(d)&&(d=this.defaultValue(f));var g;if(a.isNull(d))switch(c){case"model":g=b?b.call(this,f,{},e):d;break;case"collection":g=b?b.call(this,f,[],e):d;break;default:g=d}else g=b?b.call(this,f,d,e):d;h.push(g)},this),a.object([f],[d?h:h[0]])})},_transformToJsonToHandleArrays:function(b,c){return a.wrap(b,function(b,d,e,f){var g;return c?(g=e,a(g).map(function(a){return b.call(this,d,a,f)})):b.call(this,d,e,f)})},_bindHandlers:function(b){var c=b.getter,d=b.setter;return c&&(b.getter=a.bind(c,this)),d&&(b.setter=a.bind(d,this)),this}}),d});